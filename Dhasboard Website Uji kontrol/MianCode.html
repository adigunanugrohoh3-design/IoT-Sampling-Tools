<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Sampling Tools</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Paho MQTT Client for web browser -->
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js"></script>
    <style>
        /* Mengatur font Inter dan tema gelap */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c1a2c; /* Deep space dark blue */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #1a2a40; /* Darker card background */
            border: 1px solid #334155;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        .critical { color: #f87171; } /* Merah */
        .warning { color: #fbbf24; } /* Kuning */
        .normal { color: #34d399; } /* Hijau */
        
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a2a40; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <!-- ----------------- LOGIN SCREEN ----------------- -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="card p-8 rounded-xl w-full max-w-sm text-center transform transition duration-500 hover:scale-[1.02]">
            <svg class="w-12 h-12 mx-auto text-blue-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37h.001z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-white mb-6">IoT Sampling Tools</h2>
            <div class="space-y-4">
                <input type="text" id="login-username" placeholder="Username (rnd)" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-blue-500 focus:border-blue-500" autocomplete="username">
                <input type="password" id="login-password" placeholder="Password (tools2025)" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-blue-500 focus:border-blue-500" autocomplete="current-password" onkeypress="if(event.key === 'Enter') handleMockLogin()">
                <p id="login-error" class="text-sm text-red-400 hidden">Password salah. Coba lagi.</p>
                <button onclick="handleMockLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-xl">
                    MASUK
                </button>
            </div>
        </div>
    </div>
    
    <!-- ----------------- MAIN DASHBOARD CONTENT ----------------- -->
    <div id="app" class="min-h-screen p-4 sm:p-8 hidden">

        <!-- Header Global -->
        <header class="mb-8 border-b border-blue-800 pb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-900/50 rounded-lg p-4 sticky top-0 z-10">
            <h1 class="text-3xl font-bold text-white mb-2 sm:mb-0">
                <span class="text-blue-400">IoT</span> Sampling Tools
            </h1>
            <div class="flex items-center space-x-4">
                <span id="mqtt-status" class="text-sm font-medium rounded-full px-3 py-1 bg-red-800 text-white shadow-inner">
                    MQTT: Disconnected
                </span>
                <button onclick="showAddChamberModal()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    + Tambah Chamber Baru
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area">
            <!-- Content will be rendered here (Overview or Detail) -->
        </div>

    </div>

    <!-- Modal for Adding New Chamber -->
    <div id="add-chamber-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-white border-b border-gray-600 pb-2">Tambah Chamber Baru</h2>
            <div class="space-y-4">
                <div>
                    <label for="chamber-name" class="block text-sm font-medium text-gray-400">Nama Chamber (Contoh: Chamber A - Varietas Padi)</label>
                    <input type="text" id="chamber-name" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="chamber-topic" class="block text-sm font-medium text-gray-400">ID Chamber Unik (Contoh: chamber1 atau chamber_v1)</label>
                    <input type="text" id="chamber-topic" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="Akan digunakan sebagai root topik MQTT">
                </div>
                <div>
                    <label for="chamber-desc" class="block text-sm font-medium text-gray-400">Deskripsi/Lokasi</label>
                    <textarea id="chamber-desc" rows="3" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="hideAddChamberModal()" class="py-2 px-4 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition duration-150">Batal</button>
                <button onclick="addChamberHandler()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">Tambahkan</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Syringe/Schedule Configuration -->
    <div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-white border-b border-gray-600 pb-2">Konfigurasi Jadwal Sampling</h2>
            <p id="schedule-chamber-name" class="text-gray-400 mb-4"></p>
            
            <div class="space-y-4">
                <div>
                    <label for="interval-minutes" class="block text-sm font-medium text-gray-400">Interval Sampling (Menit)</label>
                    <input type="number" id="interval-minutes" value="60" min="5" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p class="text-xs text-gray-500">Catatan: Perangkat akan mengambil sampel setiap X menit, diukur oleh RTC-nya sendiri.</p>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="hideScheduleModal()" class="py-2 px-4 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition duration-150">Batal</button>
                <button onclick="setScheduleHandler()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">Kirim Jadwal ke Perangkat</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase components
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, deleteDoc, getDocs, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and MQTT variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rnd-robotika-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading'; // Will be set after auth
        let isAuthReady = false;
        let isAuthenticated = false; // New flag for mock login

        // --- 0. MOCK LOGIN LOGIC ---
        const MOCK_USERNAME = 'rnd';
        const MOCK_PASSWORD = 'tools2025';

        window.handleMockLogin = function() {
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');

            errorElement.classList.add('hidden');

            if (usernameInput === MOCK_USERNAME && passwordInput === MOCK_PASSWORD) {
                isAuthenticated = true;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                initFirebase(); // Start the actual app initialization
            } else {
                errorElement.classList.remove('hidden');
                document.getElementById('login-password').value = ''; // Clear password on failure
            }
        }

        // --- 1. FIREBASE INITIALIZATION & AUTH ---
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing. Cannot initialize Firestore.");
                return;
            }
            try {
                // setLogLevel('debug'); // Uncomment for verbose Firestore logs
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("User authenticated. UID:", userId);
                        // Start listening to data and connect MQTT after auth is ready
                        listenForChambers();
                        connectMQTT();
                    } else {
                        isAuthReady = true;
                        userId = crypto.randomUUID(); // Fallback for anonymous
                        console.log("Signed in anonymously. Using generated ID:", userId);
                        // Still try to connect MQTT and listen
                        listenForChambers();
                        connectMQTT();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
            }
        }

        // --- 2. FIRESTORE DATA MANAGEMENT (Public Chambers) ---
        const CHAMBERS_COLLECTION_PATH = (appId) => `/artifacts/${appId}/public/data/chambers`;
        
        window.chambers = {};
        window.currentChamberTopic = null;
        window.currentView = 'overview'; // 'overview' | 'detail'

        function listenForChambers() {
            if (!db || !isAuthReady) return;
            
            const q = collection(db, CHAMBERS_COLLECTION_PATH(appId));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const topic = data.topicId;
                    
                    if (change.type === "added" || change.type === "modified") {
                        if (!window.chambers[topic]) {
                            // Initialize new chamber with default real-time data structure
                            window.chambers[topic] = {
                                id: change.doc.id,
                                name: data.name,
                                topicId: topic,
                                desc: data.desc,
                                // Real-time data fields
                                mq4: { value: 0, status: 'normal', timestamp: 'N/A' },
                                temp: { value: 0, timestamp: 'N/A' },
                                hum: { value: 0, timestamp: 'N/A' },
                                fanStatus: 0, // 0=OFF, 1=ON
                                syringeStatus: 'Siap',
                                log: [], // For in-memory log
                                chartData: { metana: [], labels: [] }
                            };
                            // Also subscribe the new chamber to MQTT
                            subscribeToChamber(topic); 
                        } else {
                             // Update static info if modified (e.g., name, desc)
                            window.chambers[topic].name = data.name;
                            window.chambers[topic].desc = data.desc;
                        }
                    }

                    if (change.type === "removed") {
                        delete window.chambers[topic];
                        // If the deleted chamber was in detail view, go back to overview
                        if (window.currentChamberTopic === topic) {
                            window.currentView = 'overview';
                        }
                    }
                });
                
                // Re-render UI after state change
                renderContent();
            }, (error) => {
                console.error("Error listening to chambers:", error);
            });
        }

        async function addChamberToFirestore(name, topicId, desc) {
            if (!db || !isAuthReady) {
                console.error("Firestore not ready.");
                return;
            }
            try {
                // Using runTransaction to ensure topicId uniqueness before setting
                await runTransaction(db, async (transaction) => {
                    const chambersRef = collection(db, CHAMBERS_COLLECTION_PATH(appId));
                    const snapshot = await getDocs(chambersRef);
                    
                    const exists = snapshot.docs.some(doc => doc.data().topicId === topicId);
                    if (exists) {
                        throw new Error("Topic ID sudah digunakan. Harap gunakan ID yang unik.");
                    }

                    const newDocRef = doc(chambersRef);
                    transaction.set(newDocRef, {
                        name: name,
                        topicId: topicId,
                        desc: desc,
                        createdAt: new Date().toISOString(),
                        createdBy: userId
                    });
                });
                console.log(`Chamber ${name} added successfully.`);
                hideAddChamberModal();
            } catch (error) {
                console.error("Gagal menambahkan chamber:", error.message);
                alert(`Gagal menambahkan chamber: ${error.message}`);
            }
        }
        
        window.addChamberHandler = function() {
            const name = document.getElementById('chamber-name').value.trim();
            const topicId = document.getElementById('chamber-topic').value.trim().toLowerCase();
            const desc = document.getElementById('chamber-desc').value.trim();

            if (!name || !topicId) {
                alert("Nama dan ID Chamber harus diisi.");
                return;
            }
            // Basic validation for topicId (no spaces, basic alphanumeric)
            if (!/^[a-z0-9-_]+$/.test(topicId)) {
                 alert("ID Chamber hanya boleh berisi huruf kecil, angka, garis bawah, atau strip.");
                return;
            }

            addChamberToFirestore(name, topicId, desc);
        }

        window.deleteChamber = async function(topicId) {
            if (!confirm(`Yakin ingin menghapus chamber ${topicId}? Aksi ini tidak bisa dibatalkan.`)) return;
            if (!db || !window.chambers[topicId]?.id) {
                console.error("Chamber ID tidak ditemukan atau Firestore tidak siap.");
                return;
            }
            
            try {
                const docRef = doc(db, CHAMBERS_COLLECTION_PATH(appId), window.chambers[topicId].id);
                await deleteDoc(docRef);
                console.log(`Chamber ${topicId} berhasil dihapus dari Firestore.`);
            } catch (error) {
                console.error("Gagal menghapus chamber:", error);
                alert("Gagal menghapus chamber.");
            }
        }
        
        // --- 3. UI RENDERING & VIEW MANAGEMENT ---
        
        function renderOverview() {
            const contentArea = document.getElementById('content-area');
            const chamberTopics = Object.keys(window.chambers).sort();
            
            if (chamberTopics.length === 0) {
                 contentArea.innerHTML = `
                    <div class="text-center p-12 card rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10l2 2 2-2V7m0 0l2 2 2-2m-4 0h8m-8 0v10l2 2 2-2V7m0 0l2 2 2-2m-4 0h8m-8 0v10l2 2 2-2V7m0 0l2 2 2-2m-4 0h8m-8 0v10l2 2 2-2V7m0 0l2 2 2-2m-4 0h8" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-400">Tidak ada Chamber</h3>
                        <p class="mt-1 text-sm text-gray-500">Mulai dengan menambahkan Chamber baru untuk memulai R&D.</p>
                    </div>
                `;
                return;
            }

            const chamberCardsHTML = chamberTopics.map(topicId => {
                const chamber = window.chambers[topicId];
                const mq4Class = chamber.mq4.status; // normal, warning, critical
                const mq4Value = chamber.mq4.value.toFixed(1);
                const tempValue = chamber.temp.value.toFixed(1);
                const humValue = chamber.hum.value.toFixed(1);
                const onlineStatus = mqttClient && mqttClient.isConnected() ? 'Online' : 'Offline';
                const statusColor = mqttClient && mqttClient.isConnected() ? 'bg-green-600' : 'bg-red-600';
                
                return `
                    <div class="card p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <!-- Info Section -->
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-xl font-bold text-white mb-1 flex items-center">
                                ${chamber.name}
                                <span class="ml-3 text-xs font-medium rounded-full px-2 py-0.5 ${statusColor}">${onlineStatus}</span>
                            </h2>
                            <p class="text-sm text-gray-400">ID: ${chamber.topicId} | ${chamber.desc}</p>
                            <p class="text-xs mt-2 text-gray-500">MQ-4 Update: ${chamber.mq4.timestamp}</p>
                        </div>
                        
                        <!-- Data Section -->
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-6 items-center">
                            <div>
                                <div class="text-xs font-medium text-gray-400">Metana (ppm)</div>
                                <div class="text-3xl font-extrabold text-${mq4Class === 'critical' ? 'red-500' : mq4Class === 'warning' ? 'yellow-500' : 'green-500'}">
                                    ${mq4Value}
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs font-medium text-gray-400">Suhu / Kelembaban</div>
                                <div class="text-xl font-semibold text-gray-300">
                                    ${tempValue}°C / ${humValue}%
                                </div>
                            </div>
                        </div>

                        <!-- Control Section -->
                        <div class="flex space-x-3 mt-4 sm:mt-0">
                            <button onclick="showDetail('${topicId}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                                Lihat Detail
                            </button>
                            <button onclick="deleteChamber('${topicId}')" class="bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold text-white mb-6 border-b border-gray-700 pb-2">Ringkasan Semua Chamber</h2>
                <div class="space-y-4">
                    ${chamberCardsHTML}
                </div>
            `;
        }

        let metanaChart = null;

        function renderDetail() {
            const topicId = window.currentChamberTopic;
            const chamber = window.chambers[topicId];
            if (!chamber) {
                renderOverview();
                return;
            }
            
            const mq4Value = chamber.mq4.value.toFixed(1);
            const mq4Class = chamber.mq4.status;
            const tempValue = chamber.temp.value.toFixed(1);
            const humValue = chamber.hum.value.toFixed(1);
            
            document.getElementById('content-area').innerHTML = `
                <button onclick="showOverview()" class="text-blue-400 hover:text-blue-300 flex items-center mb-6 font-medium">
                    <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Kembali ke Ringkasan
                </button>

                <h2 class="text-3xl font-bold text-white mb-2">${chamber.name}</h2>
                <p class="text-gray-400 mb-6">${chamber.desc} | ID Topik: ${topicId}</p>

                <!-- 1. Real-time Status Gauges -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <div class="card p-5 rounded-xl text-center">
                        <div class="text-xs font-medium text-gray-400">Metana (MQ-4)</div>
                        <div id="detail-mq4" class="text-5xl font-extrabold mt-1 text-${mq4Class === 'critical' ? 'red-500' : mq4Class === 'warning' ? 'yellow-500' : 'green-500'}">${mq4Value}</div>
                        <span class="text-lg text-gray-500">ppm</span>
                        <p class="text-xs text-gray-600 mt-2">Terakhir: ${chamber.mq4.timestamp}</p>
                    </div>
                    <div class="card p-5 rounded-xl text-center">
                        <div class="text-xs font-medium text-gray-400">Suhu (BME280)</div>
                        <div id="detail-temp" class="text-5xl font-extrabold mt-1 text-blue-400">${tempValue}</div>
                        <span class="text-lg text-gray-500">°C</span>
                        <p class="text-xs text-gray-600 mt-2">Terakhir: ${chamber.temp.timestamp}</p>
                    </div>
                    <div class="card p-5 rounded-xl text-center">
                        <div class="text-xs font-medium text-gray-400">Kelembaban (BME280)</div>
                        <div id="detail-hum" class="text-5xl font-extrabold mt-1 text-purple-400">${humValue}</div>
                        <span class="text-lg text-gray-500">%</span>
                        <p class="text-xs text-gray-600 mt-2">Terakhir: ${chamber.hum.timestamp}</p>
                    </div>
                </div>

                <!-- 2. Charts and Control Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Chart Panel (2/3 width on large screen) -->
                    <div class="lg:col-span-2 card p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Tren Data Metana</h3>
                        <div class="h-96">
                            <canvas id="metanaChart"></canvas>
                        </div>
                    </div>

                    <!-- Control Panel (1/3 width on large screen) -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Aktuator Control -->
                        <div class="card p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Kontrol Aktuator</h3>
                            
                            <!-- Fan Control -->
                            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                                <div>
                                    <p class="text-lg font-medium">Kipas Homogenisasi</p>
                                    <span id="fan-status-text" class="text-sm text-gray-400">${chamber.fanStatus ? 'ON' : 'OFF'}</span>
                                </div>
                                <button onclick="toggleFan('${topicId}', ${chamber.fanStatus})" class="py-2 px-4 rounded-lg font-bold text-sm ${chamber.fanStatus ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-600 hover:bg-gray-700'} text-white transition duration-200 shadow-md">
                                    ${chamber.fanStatus ? 'Matikan' : 'Nyalakan'}
                                </button>
                            </div>

                            <!-- Syringe Control -->
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-lg font-medium">Syringe (Pengambilan Sampel)</p>
                                    <span id="syringe-status-text" class="text-sm text-gray-400">${chamber.syringeStatus}</span>
                                </div>
                                <button onclick="publishSyringeManual('${topicId}')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.05]">
                                    Ambil Sampel Manual
                                </button>
                            </div>
                        </div>

                        <!-- Schedule Configuration -->
                        <div class="card p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Konfigurasi RTC & Jadwal</h3>
                            <p class="text-gray-400 mb-4 text-sm">Atur interval pengambilan sampel otomatis.</p>
                            <button onclick="showScheduleModal('${topicId}')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.02]">
                                Set Jadwal Sampling
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. Activity Log -->
                <div class="mt-8 card p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Log Aktivitas Terkini</h3>
                    <div id="activity-log" class="text-sm space-y-2 max-h-64 overflow-y-auto text-gray-400 p-3 bg-gray-900 rounded-lg border border-gray-700">
                        <!-- Log entries will be added here -->
                    </div>
                </div>
            `;
            
            // Re-initialize chart
            initChart(topicId);
            updateDetailUI(chamber);
        }

        window.showOverview = function() {
            window.currentView = 'overview';
            window.currentChamberTopic = null;
            if (metanaChart) metanaChart.destroy(); // Destroy chart when leaving detail view
            renderContent();
        }

        window.showDetail = function(topicId) {
            window.currentChamberTopic = topicId;
            window.currentView = 'detail';
            renderContent();
        }

        function renderContent() {
            if (window.currentView === 'overview') {
                renderOverview();
            } else if (window.currentView === 'detail') {
                renderDetail();
            }
        }
        
        function updateDetailUI(chamber) {
            if (window.currentView !== 'detail' || chamber.topicId !== window.currentChamberTopic) return;

            // 1. Update Gauges
            const mq4Value = chamber.mq4.value.toFixed(1);
            const mq4Class = chamber.mq4.status;
            document.getElementById('detail-mq4').textContent = mq4Value;
            document.getElementById('detail-mq4').className = `text-5xl font-extrabold mt-1 text-${mq4Class === 'critical' ? 'red-500' : mq4Class === 'warning' ? 'yellow-500' : 'green-500'}`;
            document.getElementById('detail-temp').textContent = chamber.temp.value.toFixed(1);
            document.getElementById('detail-hum').textContent = chamber.hum.value.toFixed(1);

            // 2. Update Actuator Control Button/Status
            const fanButton = document.querySelector(`[onclick="toggleFan('${chamber.topicId}', ${chamber.fanStatus})"]`);
            if (fanButton) {
                fanButton.textContent = chamber.fanStatus ? 'Matikan' : 'Nyalakan';
                fanButton.className = `py-2 px-4 rounded-lg font-bold text-sm text-white transition duration-200 shadow-md ${chamber.fanStatus ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-600 hover:bg-gray-700'}`;
                document.getElementById('fan-status-text').textContent = chamber.fanStatus ? 'ON' : 'OFF';
            }
            document.getElementById('syringe-status-text').textContent = chamber.syringeStatus;

            // 3. Update Chart
            if (metanaChart) {
                metanaChart.data.labels = chamber.chartData.labels;
                metanaChart.data.datasets[0].data = chamber.chartData.metana;
                metanaChart.update();
            }
            
            // 4. Update Log
            const logHTML = chamber.log.slice(-5).reverse().map(entry => `
                <p class="text-xs"><span class="font-bold text-blue-400">[${entry.time}]</span> ${entry.message}</p>
            `).join('');
            document.getElementById('activity-log').innerHTML = logHTML || '<p class="text-center text-gray-600">Tidak ada aktivitas log.</p>';
        }

        // --- 4. CHART.JS VISUALIZATION ---

        function initChart(topicId) {
            if (metanaChart) metanaChart.destroy(); // Ensure old chart is destroyed

            const ctx = document.getElementById('metanaChart').getContext('2d');
            const chamber = window.chambers[topicId];
            
            metanaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chamber.chartData.labels,
                    datasets: [{
                        label: 'Metana (ppm)',
                        data: chamber.chartData.metana,
                        borderColor: '#34d399', // Green
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#34d399',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#e2e8f0' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#e2e8f0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Metana: ${context.parsed.y.toFixed(2)} ppm`;
                                }
                            },
                            backgroundColor: '#1a2a40',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    }
                }
            });
        }


        // --- 5. MQTT CLIENT LOGIC ---

        const HOST = 'broker.hivemq.com'; // Contoh broker publik
        const PORT = 8000; // Port webSocket
        const CLIENT_ID = 'WebDashboard-' + Math.random().toString(16).substr(2, 8);
        
        let mqttClient = null;

        function connectMQTT() {
            if (!Paho.MQTT || mqttClient) return;

            mqttClient = new Paho.MQTT.Client(HOST, PORT, "/mqtt", CLIENT_ID);

            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            mqttClient.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: false // Set to true if using SSL/TLS port
            });
        }

        function onConnect() {
            console.log("MQTT Connected!");
            document.getElementById('mqtt-status').textContent = 'MQTT: Connected';
            document.getElementById('mqtt-status').className = 'text-sm font-medium rounded-full px-3 py-1 bg-green-600 text-white shadow-inner';
            
            // Re-subscribe to all existing chambers
            Object.keys(window.chambers).forEach(topicId => subscribeToChamber(topicId));
        }
        
        function onFailure(responseObject) {
            console.error("MQTT Connection failed:", responseObject.errorMessage);
            document.getElementById('mqtt-status').textContent = 'MQTT: Failed';
            document.getElementById('mqtt-status').className = 'text-sm font-medium rounded-full px-3 py-1 bg-red-600 text-white shadow-inner';
            // Optional: Implement reconnect logic with exponential backoff
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT Connection Lost:", responseObject.errorMessage);
                document.getElementById('mqtt-status').textContent = 'MQTT: Disconnected';
                document.getElementById('mqtt-status').className = 'text-sm font-medium rounded-full px-3 py-1 bg-red-800 text-white shadow-inner';
            }
        }

        function subscribeToChamber(topicId) {
            if (!mqttClient || !mqttClient.isConnected()) return;
            
            // Subscribe to all sensor topics for this specific chamber
            const sensorRoot = `robotika/${topicId}/sensor/#`;
            const statusRoot = `robotika/${topicId}/status/#`;
            
            mqttClient.subscribe(sensorRoot, { qos: 1 });
            mqttClient.subscribe(statusRoot, { qos: 1 });
            console.log(`Subscribed to: ${sensorRoot} and ${statusRoot}`);
        }

        function onMessageArrived(message) {
            const fullTopic = message.destinationName;
            const payload = message.payloadString;
            
            // Extract the chamber ID from the topic (robotika/chamberX/...)
            const topicParts = fullTopic.split('/');
            if (topicParts.length < 3 || topicParts[0] !== 'robotika') return;
            
            const topicId = topicParts[1];
            if (!window.chambers[topicId]) {
                console.warn(`Pesan tiba untuk chamber yang tidak dikenal: ${topicId}`);
                return;
            }

            const chamber = window.chambers[topicId];
            const timestamp = new Date().toLocaleTimeString('id-ID');
            
            try {
                // Determine topic type
                const dataType = topicParts[2]; // 'sensor' or 'status'
                const sensorType = topicParts[3]; // 'metana', 'suhu', 'humidity', 'relay_status', etc.

                if (dataType === 'sensor') {
                    const value = parseFloat(payload);
                    if (isNaN(value)) return;
                    
                    if (sensorType === 'metana') {
                        chamber.mq4.value = value;
                        chamber.mq4.timestamp = timestamp;
                        // Simple status logic: > 500 = critical, > 300 = warning
                        if (value > 500) chamber.mq4.status = 'critical';
                        else if (value > 300) chamber.mq4.status = 'warning';
                        else chamber.mq4.status = 'normal';
                        
                        // Add to chart data (max 20 points for demo)
                        chamber.chartData.metana.push(value);
                        chamber.chartData.labels.push(timestamp);
                        if (chamber.chartData.metana.length > 20) {
                            chamber.chartData.metana.shift();
                            chamber.chartData.labels.shift();
                        }
                        
                    } else if (sensorType === 'suhu') {
                        chamber.temp.value = value;
                        chamber.temp.timestamp = timestamp;
                    } else if (sensorType === 'humidity') {
                        chamber.hum.value = value;
                        chamber.hum.timestamp = timestamp;
                    }
                } else if (dataType === 'status') {
                    if (sensorType === 'relay_status') {
                        const status = parseInt(payload);
                        if (!isNaN(status)) chamber.fanStatus = status;
                        chamber.log.push({ time: timestamp, message: `Status Kipas diperbarui ke: ${status ? 'ON' : 'OFF'}` });
                    } else if (sensorType === 'last_action') {
                        // Example: "Syringe: UP" or "Sampling Complete"
                        chamber.syringeStatus = payload;
                        chamber.log.push({ time: timestamp, message: `Aksi Syringe: ${payload}` });
                    }
                }
                
                // Update UI based on current view
                if (window.currentView === 'overview') {
                    renderOverview();
                } else if (window.currentChamberTopic === topicId && window.currentView === 'detail') {
                    updateDetailUI(chamber);
                }

            } catch (e) {
                console.error("Error processing MQTT message:", e);
            }
        }

        // --- 6. CONTROL & COMMAND FUNCTIONS (Publishing) ---

        function publishControl(topic, payload) {
            if (!mqttClient || !mqttClient.isConnected()) {
                alert("MQTT Disconnected. Please check connection status.");
                return;
            }
            
            const message = new Paho.MQTT.Message(String(payload));
            message.destinationName = topic;
            message.qos = 1; // Reliable delivery
            mqttClient.send(message);
            
            console.log(`Published to ${topic} with payload: ${payload}`);
        }

        window.toggleFan = function(topicId, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            const topic = `robotika/${topicId}/kontrol/fan`;
            publishControl(topic, newStatus);
            // Optimistically update the UI, final confirmation comes from status message
            window.chambers[topicId].fanStatus = newStatus;
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Kipas: ${newStatus ? 'ON' : 'OFF'} dikirim.` });
            if (window.currentView === 'detail') updateDetailUI(window.chambers[topicId]);
        }

        window.publishSyringeManual = function(topicId) {
            const topic = `robotika/${topicId}/kontrol/syringe/manual`;
            const payload = 'START';
            publishControl(topic, payload);
            window.chambers[topicId].syringeStatus = 'Proses Ambil Sampel...';
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Ambil Sampel Manual dikirim.` });
            if (window.currentView === 'detail') updateDetailUI(window.chambers[topicId]);
        }
        
        window.setScheduleHandler = function() {
            const topicId = document.getElementById('schedule-modal').dataset.topicId;
            const interval = parseInt(document.getElementById('interval-minutes').value);
            
            if (isNaN(interval) || interval < 5) {
                alert("Interval harus berupa angka valid (minimal 5 menit).");
                return;
            }
            
            const topic = `robotika/${topicId}/config/set_schedule`;
            const payload = JSON.stringify({ intervalMinutes: interval });
            
            publishControl(topic, payload);
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Jadwal Interval: ${interval} menit dikirim.` });
            if (window.currentView === 'detail') updateDetailUI(window.chambers[topicId]);
            hideScheduleModal();
        }

        // --- 7. MODAL FUNCTIONS ---
        window.showAddChamberModal = () => document.getElementById('add-chamber-modal').classList.remove('hidden');
        window.hideAddChamberModal = () => document.getElementById('add-chamber-modal').classList.add('hidden');

        window.showScheduleModal = (topicId) => {
            document.getElementById('schedule-modal').dataset.topicId = topicId;
            document.getElementById('schedule-chamber-name').textContent = `Mengatur jadwal untuk: ${window.chambers[topicId].name}`;
            document.getElementById('schedule-modal').classList.remove('hidden');
        }
        window.hideScheduleModal = () => document.getElementById('schedule-modal').classList.add('hidden');


        // --- APPLICATION START ---
        window.onload = function() {
            // Check if user is already authenticated (e.g., if a previous successful session)
            // For this mock setup, we always show the login screen initially.
            
            // Initial render before data is loaded (shows loading state in the main app div)
            document.getElementById('content-area').innerHTML = `
                <div class="text-center p-12 text-gray-400">
                    <svg class="animate-spin mx-auto h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4">Menunggu Login...</p>
                </div>
            `;
            // Init Firebase is now called only after successful mock login.
        };

    </script>
</body>
</html>
