<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Sampling Tools - Dashboard Uji Coba R&D</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk visualisasi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Memuat Paho MQTT Client untuk web browser -->
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js"></script>
    <style>
        /* Mengatur font Inter dan tema terang */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9; /* Latar belakang terang */
            color: #1f2937; /* Teks Gelap */
        }
        .card {
            background-color: #ffffff; /* Latar belakang kartu putih */
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .critical { color: #dc2626; } /* Merah */
        .warning { color: #f59e0b; } /* Kuning */
        .normal { color: #10b981; } /* Hijau */
        
        /* Gaya input waktu */
        .time-input {
            width: 100%;
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- ----------------- LAYAR LOGIN (MOCK) ----------------- -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 bg-opacity-95 flex items-center justify-center z-50">
        <div class="card p-8 rounded-xl w-full max-w-sm text-center transform transition duration-500 hover:scale-[1.02] shadow-2xl">
            <svg class="w-12 h-12 mx-auto text-blue-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37h.001z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">IoT Sampling Tools</h2>
            <div class="space-y-4">
                <input type="text" id="login-username" placeholder="Username (rnd)" class="w-full bg-gray-50 border border-gray-300 rounded-md p-3 text-gray-900 focus:ring-blue-500 focus:border-blue-500" autocomplete="username">
                <input type="password" id="login-password" placeholder="Password (tools2025)" class="w-full bg-gray-50 border border-gray-300 rounded-md p-3 text-gray-900 focus:ring-blue-500 focus:border-blue-500" autocomplete="current-password" onkeypress="if(event.key === 'Enter') handleMockLogin()">
                <p id="login-error" class="text-sm text-red-500 hidden">Kredensial salah. Coba lagi.</p>
                <button onclick="handleMockLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                    MASUK
                </button>
            </div>
        </div>
    </div>
    
    <!-- ----------------- KONTEN DASHBOARD UTAMA ----------------- -->
    <div id="app" class="min-h-screen p-4 sm:p-8 hidden">

        <!-- Header Global -->
        <header class="mb-6 border-b border-gray-300 pb-4 flex justify-between items-center bg-white/70 backdrop-blur-sm rounded-lg p-4 sticky top-0 z-10 shadow-md">
            <h1 class="text-3xl font-bold text-gray-900">
                <span class="text-blue-600">R&D</span> Sampling Uji Coba
            </h1>
        </header>

        <!-- Toolbar Koneksi Perangkat -->
        <div id="connection-toolbar" class="card p-4 mb-6 flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
            <span id="mqtt-status" class="text-sm font-medium rounded-full px-3 py-1 bg-red-200 text-red-800 shadow-inner w-full md:w-auto text-center">
                Device Connection: Disconnected
            </span>
            <input type="text" id="mqtt-host" value="broker.hivemq.com" placeholder="Broker Host" class="w-full md:w-1/3 bg-gray-50 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            <input type="number" id="mqtt-port" value="8000" placeholder="Port (WebSocket)" class="w-full md:w-auto bg-gray-50 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            
            <button id="mqtt-connect-btn" onclick="connectMQTT()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                Connect Device
            </button>
            <button id="mqtt-disconnect-btn" onclick="disconnectMQTT()" class="w-full md:w-auto bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md hidden">
                Disconnect
            </button>
        </div>

        <!-- Area Konten Dinamis -->
        <div id="content-area">
            <div class="text-center p-12 text-gray-500">
                <svg class="animate-spin mx-auto h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">Memuat Konfigurasi Chamber Uji Coba...</p>
            </div>
        </div>

    </div>

    <!-- Modal Konfigurasi Jadwal Waktu -->
    <div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="card p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 border-b border-gray-300 pb-2">Konfigurasi Jadwal Sampling Waktu</h2>
            <p id="schedule-chamber-name" class="text-gray-500 mb-4"></p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="time-slot-1" class="block text-sm font-medium text-gray-700 mb-1">Slot 1 (HH:MM)</label>
                        <input type="time" id="time-slot-1" value="08:00" class="time-input">
                    </div>
                    <div>
                        <label for="time-slot-2" class="block text-sm font-medium text-gray-700 mb-1">Slot 2 (HH:MM)</label>
                        <input type="time" id="time-slot-2" value="12:00" class="time-input">
                    </div>
                    <div>
                        <label for="time-slot-3" class="block text-sm font-medium text-gray-700 mb-1">Slot 3 (HH:MM)</label>
                        <input type="time" id="time-slot-3" value="16:00" class="time-input">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-4">Catatan: Perangkat akan mengambil sampel pada waktu yang tepat ini, diukur oleh RTC internalnya. Pastikan Anda mengatur RTC ESP32 ke waktu yang benar.</p>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="hideScheduleModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">Batal</button>
                <button onclick="setScheduleHandler()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">Kirim Jadwal Waktu</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import komponen Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global Firebase dan MQTT
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rnd-robotika-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- KONFIGURASI CHAMBER UJI COBA ---
        const TEST_CHAMBER_ID = 'chamber_test';

        let app, db, auth;
        let userId = 'loading'; // Akan diatur setelah otentikasi
        let isAuthReady = false;
        let isAuthenticated = false; 

        // --- 0. LOGIKA MOCK LOGIN ---
        const MOCK_USERNAME = 'rnd';
        const MOCK_PASSWORD = 'tools2025';

        window.handleMockLogin = function() {
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');

            errorElement.classList.add('hidden');

            if (usernameInput === MOCK_USERNAME && passwordInput === MOCK_PASSWORD) {
                isAuthenticated = true;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                initFirebase(); // Mulai inisialisasi aplikasi
            } else {
                errorElement.classList.remove('hidden');
                document.getElementById('login-password').value = ''; // Kosongkan sandi jika gagal
            }
        }

        // --- 1. INISIALISASI FIREBASE & AUTH ---
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Konfigurasi Firebase tidak ada.");
                return;
            }
            try {
                // setLogLevel('debug'); // Aktifkan untuk log verbose
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in dengan custom token atau secara anonim
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Pengguna terotentikasi. UID:", userId);
                        initializeTestChamber();
                    } else {
                        isAuthReady = true;
                        userId = crypto.randomUUID(); // Fallback untuk anonim
                        console.log("Masuk secara anonim. Menggunakan ID yang dibuat:", userId);
                        initializeTestChamber();
                    }
                });
            } catch (error) {
                console.error("Error inisialisasi Firebase atau otentikasi:", error);
            }
        }

        // --- 2. MANAJEMEN DATA FIRESTORE ---
        const CHAMBERS_COLLECTION_PATH = (appId) => `/artifacts/${appId}/public/data/chambers`;
        
        window.chambers = {};
        window.currentChamberTopic = TEST_CHAMBER_ID;
        window.currentView = 'detail'; 

        // Fungsi untuk memastikan chamber_test ada di Firestore dan mulai mendengarkan
        async function initializeTestChamber() {
            if (!db || !isAuthReady) return;
            
            const chamberRef = doc(collection(db, CHAMBERS_COLLECTION_PATH(appId)), TEST_CHAMBER_ID);
            
            // Menggunakan onSnapshot untuk real-time data dan inisialisasi
            onSnapshot(chamberRef, (docSnap) => {
                const docData = docSnap.data();
                
                if (!docSnap.exists() || !docData) {
                    // Buat dokumen chamber_test jika belum ada
                    setDoc(chamberRef, {
                        name: "Chamber Uji Coba - Test Chamber",
                        topicId: TEST_CHAMBER_ID,
                        desc: "Lingkungan uji coba untuk mengintegrasikan ESP32.",
                        createdAt: new Date().toISOString(),
                        createdBy: userId
                    }, { merge: true })
                    .then(() => console.log("Test Chamber dibuat/diverifikasi di Firestore."))
                    .catch(e => console.error("Error membuat test chamber:", e));
                    return;
                }
                
                // Jika sudah ada, siapkan data awal di memory
                if (!window.chambers[TEST_CHAMBER_ID]) {
                    window.chambers[TEST_CHAMBER_ID] = {
                        id: TEST_CHAMBER_ID,
                        name: docData.name,
                        topicId: TEST_CHAMBER_ID,
                        desc: docData.desc,
                        mq4: { value: 0, status: 'normal', timestamp: 'N/A' },
                        temp: { value: 0, timestamp: 'N/A' },
                        hum: { value: 0, timestamp: 'N/A' },
                        fanStatus: 0, 
                        syringeStatus: 'Siap',
                        log: [], 
                        chartData: { metana: [], labels: [] }
                    };
                    renderContent(); // Render awal
                }
                
            }, (error) => {
                console.error("Error mendengarkan test chamber:", error);
            });
        }

        // --- 3. UI RENDERING ---
        
        let metanaChart = null;

        function renderDetail(topicId) {
            const chamber = window.chambers[topicId];
            if (!chamber) return;
            
            const mq4Value = chamber.mq4.value.toFixed(1);
            const mq4Class = chamber.mq4.status;
            const tempValue = chamber.temp.value.toFixed(1);
            const humValue = chamber.hum.value.toFixed(1);
            
            document.getElementById('content-area').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-2">${chamber.name}</h2>
                <p class="text-gray-500 mb-6">${chamber.desc} | ID Topik: <span class="font-mono text-blue-600">${topicId}</span></p>

                <!-- 1. Status Real-time -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <div class="card p-5 text-center">
                        <div class="text-xs font-medium text-gray-500">Metana (MQ-4)</div>
                        <div id="detail-mq4" class="text-5xl font-extrabold mt-1 text-${mq4Class === 'critical' ? 'red-600' : mq4Class === 'warning' ? 'yellow-600' : 'green-600'}">${mq4Value}</div>
                        <span class="text-lg text-gray-400">ppm</span>
                        <p class="text-xs text-gray-400 mt-2">Terakhir: ${chamber.mq4.timestamp}</p>
                    </div>
                    <div class="card p-5 text-center">
                        <div class="text-xs font-medium text-gray-500">Suhu (BME280)</div>
                        <div id="detail-temp" class="text-5xl font-extrabold mt-1 text-blue-600">${tempValue}</div>
                        <span class="text-lg text-gray-400">Â°C</span>
                        <p class="text-xs text-gray-400 mt-2">Terakhir: ${chamber.temp.timestamp}</p>
                    </div>
                    <div class="card p-5 text-center">
                        <div class="text-xs font-medium text-gray-500">Kelembaban (BME280)</div>
                        <div id="detail-hum" class="text-5xl font-extrabold mt-1 text-purple-600">${humValue}</div>
                        <span class="text-lg text-gray-400">%</span>
                        <p class="text-xs text-gray-400 mt-2">Terakhir: ${chamber.hum.timestamp}</p>
                    </div>
                </div>

                <!-- 2. Grafik dan Panel Kontrol -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Panel Grafik -->
                    <div class="lg:col-span-2 card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 border-b border-gray-300 pb-2">Tren Data Metana</h3>
                        <div class="h-96">
                            <canvas id="metanaChart"></canvas>
                        </div>
                    </div>

                    <!-- Panel Kontrol -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Kontrol Aktuator -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 border-b border-gray-300 pb-2">Kontrol Aktuator</h3>
                            
                            <!-- Kontrol Kipas -->
                            <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-4">
                                <div>
                                    <p class="text-lg font-medium">Kipas Homogenisasi (Relay)</p>
                                    <span id="fan-status-text" class="text-sm text-gray-500">${chamber.fanStatus ? 'ON' : 'OFF'}</span>
                                </div>
                                <button onclick="toggleFan('${topicId}', ${chamber.fanStatus})" class="py-2 px-4 rounded-lg font-bold text-sm ${chamber.fanStatus ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-500 hover:bg-gray-600'} text-white transition duration-200 shadow-md">
                                    ${chamber.fanStatus ? 'Matikan' : 'Nyalakan'}
                                </button>
                            </div>

                            <!-- Kontrol Syringe -->
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-lg font-medium">Syringe (Motor DC/L298N)</p>
                                    <span id="syringe-status-text" class="text-sm text-gray-500">${chamber.syringeStatus}</span>
                                </div>
                                <button onclick="publishSyringeManual('${topicId}')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.05]">
                                    Ambil Sampel Manual
                                </button>
                            </div>
                        </div>

                        <!-- Konfigurasi Jadwal -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 border-b border-gray-300 pb-2">Konfigurasi RTC & Jadwal</h3>
                            <p class="text-gray-500 mb-4 text-sm">Setel waktu pengambilan sampel otomatis (HH:MM).</p>
                            <button onclick="showScheduleModal('${topicId}')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md transform hover:scale-[1.02]">
                                Set Jadwal Waktu
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. Log Aktivitas -->
                <div class="mt-8 card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900 border-b border-gray-300 pb-2">Log Aktivitas Terkini</h3>
                    <div id="activity-log" class="text-sm space-y-2 max-h-64 overflow-y-auto text-gray-600 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- Log aktivitas akan ditambahkan di sini -->
                    </div>
                </div>
            `;
            
            // Inisialisasi ulang grafik
            initChart(topicId);
            updateDetailUI(chamber);
        }

        function renderContent() {
            if (window.chambers[TEST_CHAMBER_ID]) {
                renderDetail(TEST_CHAMBER_ID);
            }
        }
        
        function updateDetailUI(chamber) {
            if (chamber.topicId !== window.currentChamberTopic) return;

            // 1. Update Gauges/Angka
            const mq4Value = chamber.mq4.value.toFixed(1);
            const mq4Class = chamber.mq4.status;
            const mq4Element = document.getElementById('detail-mq4');
            if (mq4Element) {
                mq4Element.textContent = mq4Value;
                mq4Element.className = `text-5xl font-extrabold mt-1 text-${mq4Class === 'critical' ? 'red-600' : mq4Class === 'warning' ? 'yellow-600' : 'green-600'}`;
            }

            const tempElement = document.getElementById('detail-temp');
            if (tempElement) tempElement.textContent = chamber.temp.value.toFixed(1);
            
            const humElement = document.getElementById('detail-hum');
            if (humElement) humElement.textContent = chamber.hum.value.toFixed(1);

            // 2. Update Status Aktuator
            const fanButton = document.querySelector(`[onclick="toggleFan('${chamber.topicId}', ${chamber.fanStatus})"]`);
            if (fanButton) {
                fanButton.textContent = chamber.fanStatus ? 'Matikan' : 'Nyalakan';
                fanButton.className = `py-2 px-4 rounded-lg font-bold text-sm text-white transition duration-200 shadow-md ${chamber.fanStatus ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-500 hover:bg-gray-600'}`;
                document.getElementById('fan-status-text').textContent = chamber.fanStatus ? 'ON' : 'OFF';
            }
            const syringeStatusElement = document.getElementById('syringe-status-text');
            if (syringeStatusElement) syringeStatusElement.textContent = chamber.syringeStatus;


            // 3. Update Grafik
            if (metanaChart) {
                metanaChart.data.labels = chamber.chartData.labels;
                metanaChart.data.datasets[0].data = chamber.chartData.metana;
                metanaChart.update();
            }
            
            // 4. Update Log
            const logElement = document.getElementById('activity-log');
            if (logElement) {
                // Tampilkan 5 entri log terbaru
                const logHTML = chamber.log.slice(-5).reverse().map(entry => `
                    <p class="text-xs"><span class="font-bold text-blue-600">[${entry.time}]</span> ${entry.message}</p>
                `).join('');
                logElement.innerHTML = logHTML || '<p class="text-center text-gray-400">Tidak ada aktivitas log.</p>';
            }
        }

        // --- 4. CHART.JS VISUALIZATION ---

        function initChart(topicId) {
            if (metanaChart) metanaChart.destroy(); 

            const ctx = document.getElementById('metanaChart').getContext('2d');
            const chamber = window.chambers[topicId];
            
            metanaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chamber.chartData.labels,
                    datasets: [{
                        label: 'Metana (ppm)',
                        data: chamber.chartData.metana,
                        borderColor: '#10b981', // Hijau
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#10b981',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: '#f3f4f6' },
                            ticks: { color: '#374151' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' },
                            ticks: { color: '#374151' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Metana: ${context.parsed.y.toFixed(2)} ppm`;
                                }
                            },
                            backgroundColor: '#ffffff',
                            titleColor: '#1f2937',
                            bodyColor: '#1f2937',
                            borderColor: '#e5e7eb',
                            borderWidth: 1
                        }
                    }
                }
            });
        }


        // --- 5. LOGIKA KONEKSI PERANGKAT (MQTT) ---

        const CLIENT_ID = 'WebDashboard-Test-' + Math.random().toString(16).substr(2, 8);
        let mqttClient = null;
        let mqttHost = '';
        let mqttPort = 0;

        function updateMQTTStatusUI(isConnected, errorMessage = '') {
            const statusElement = document.getElementById('mqtt-status');
            const connectBtn = document.getElementById('mqtt-connect-btn');
            const disconnectBtn = document.getElementById('mqtt-disconnect-btn');

            if (isConnected) {
                statusElement.textContent = 'Device Connection: Connected';
                statusElement.className = 'text-sm font-medium rounded-full px-3 py-1 bg-green-200 text-green-800 shadow-inner w-full md:w-auto text-center';
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
            } else {
                statusElement.textContent = `Device Connection: Disconnected ${errorMessage ? '(' + errorMessage + ')' : ''}`;
                statusElement.className = 'text-sm font-medium rounded-full px-3 py-1 bg-red-200 text-red-800 shadow-inner w-full md:w-auto text-center';
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
            }
        }

        window.connectMQTT = function() {
            if (mqttClient && mqttClient.isConnected()) return;
            
            mqttHost = document.getElementById('mqtt-host').value;
            mqttPort = parseInt(document.getElementById('mqtt-port').value);
            
            if (!mqttHost || isNaN(mqttPort)) {
                alert("Harap isi Host dan Port Broker yang valid.");
                return;
            }

            try {
                // Paho.MQTT.Client(host, port, path, clientId)
                mqttClient = new Paho.MQTT.Client(mqttHost, mqttPort, "/mqtt", CLIENT_ID);

                mqttClient.onConnectionLost = onConnectionLost;
                mqttClient.onMessageArrived = onMessageArrived;

                updateMQTTStatusUI(false, 'Connecting...');
                
                mqttClient.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    cleanSession: true,
                    useSSL: false // Umumnya port 8000 (WebSocket) tidak menggunakan SSL
                });
            } catch (e) {
                console.error("Error inisialisasi Klien MQTT:", e);
                updateMQTTStatusUI(false, 'Error in setup');
            }
        }
        
        window.disconnectMQTT = function() {
            if (mqttClient && mqttClient.isConnected()) {
                mqttClient.disconnect();
                updateMQTTStatusUI(false, 'Manual Disconnect');
            }
        }

        function onConnect() {
            console.log("Device Connection: Connected!");
            updateMQTTStatusUI(true);
            
            // Subscribe ke chamber_test
            subscribeToTestChamber(TEST_CHAMBER_ID);
        }
        
        function onFailure(responseObject) {
            console.error("Koneksi Device gagal:", responseObject.errorMessage);
            updateMQTTStatusUI(false, 'Failed');
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("Koneksi Device terputus:", responseObject.errorMessage);
                updateMQTTStatusUI(false, 'Lost');
            }
        }

        function subscribeToTestChamber(topicId) {
            if (!mqttClient || !mqttClient.isConnected()) return;
            
            // TOPIC SENSOR dan KONTROL harus sesuai dengan kode ESP32
            const sensorRoot = `robotika/${topicId}/sensor/#`;
            const statusRoot = `robotika/${topicId}/status/#`;
            
            mqttClient.subscribe(sensorRoot, { qos: 1 });
            mqttClient.subscribe(statusRoot, { qos: 1 });
            console.log(`Subscribed to: ${sensorRoot} and ${statusRoot}`);
        }

        function onMessageArrived(message) {
            const fullTopic = message.destinationName;
            const payload = message.payloadString;
            
            const topicParts = fullTopic.split('/');
            // Pastikan pesan untuk chamber_test
            if (topicParts.length < 3 || topicParts[1] !== TEST_CHAMBER_ID) return;
            
            const chamber = window.chambers[TEST_CHAMBER_ID];
            const timestamp = new Date().toLocaleTimeString('id-ID');
            
            try {
                const dataType = topicParts[2]; 
                const sensorType = topicParts[3]; 

                if (dataType === 'sensor') {
                    const value = parseFloat(payload);
                    if (isNaN(value)) return;
                    
                    if (sensorType === 'metana') {
                        chamber.mq4.value = value;
                        chamber.mq4.timestamp = timestamp;
                        // Logika status: > 500 = critical, > 300 = warning
                        if (value > 500) chamber.mq4.status = 'critical';
                        else if (value > 300) chamber.mq4.status = 'warning';
                        else chamber.mq4.status = 'normal';
                        
                        chamber.chartData.metana.push(value);
                        chamber.chartData.labels.push(timestamp);
                        // Batasi data chart
                        if (chamber.chartData.metana.length > 20) {
                            chamber.chartData.metana.shift();
                            chamber.chartData.labels.shift();
                        }
                        
                    } else if (sensorType === 'suhu') {
                        chamber.temp.value = value;
                        chamber.temp.timestamp = timestamp;
                    } else if (sensorType === 'humidity') {
                        chamber.hum.value = value;
                        chamber.hum.timestamp = timestamp;
                    }
                } else if (dataType === 'status') {
                    if (sensorType === 'relay_status') {
                        const status = parseInt(payload);
                        if (!isNaN(status)) chamber.fanStatus = status;
                        chamber.log.push({ time: timestamp, message: `Status Kipas (Relay) diperbarui ke: ${status ? 'ON' : 'OFF'}` });
                    } else if (sensorType === 'last_action') {
                        chamber.syringeStatus = payload;
                        chamber.log.push({ time: timestamp, message: `Aksi Syringe: ${payload}` });
                    }
                }
                
                // Perbarui UI
                updateDetailUI(chamber);

            } catch (e) {
                console.error("Error memproses pesan MQTT:", e);
            }
        }

        // --- 6. FUNGSI KONTROL & PERINTAH (Publishing) ---

        function publishControl(topic, payload) {
            if (!mqttClient || !mqttClient.isConnected()) {
                alert("Koneksi Device terputus. Harap sambungkan terlebih dahulu.");
                return;
            }
            
            const message = new Paho.MQTT.Message(String(payload));
            message.destinationName = topic;
            message.qos = 1; 
            mqttClient.send(message);
            
            console.log(`Published to ${topic} with payload: ${payload}`);
        }

        window.toggleFan = function(topicId, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            const topic = `robotika/${topicId}/kontrol/fan`;
            publishControl(topic, newStatus);
            // Update optimis
            window.chambers[topicId].fanStatus = newStatus;
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Kipas: ${newStatus ? 'ON' : 'OFF'} dikirim.` });
            updateDetailUI(window.chambers[topicId]);
        }

        window.publishSyringeManual = function(topicId) {
            const topic = `robotika/${topicId}/kontrol/syringe/manual`;
            const payload = 'START';
            publishControl(topic, payload);
            window.chambers[topicId].syringeStatus = 'Proses Ambil Sampel...';
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Ambil Sampel Manual dikirim.` });
            updateDetailUI(window.chambers[topicId]);
        }
        
        window.setScheduleHandler = function() {
            const topicId = document.getElementById('schedule-modal').dataset.topicId;
            
            // Ambil semua nilai waktu dari input
            const time1 = document.getElementById('time-slot-1').value;
            const time2 = document.getElementById('time-slot-2').value;
            const time3 = document.getElementById('time-slot-3').value;
            
            // Buat array waktu
            const scheduledTimes = [time1, time2, time3].filter(time => time); // Hilangkan yang kosong
            
            if (scheduledTimes.length === 0) {
                alert("Harap masukkan minimal satu slot waktu yang valid.");
                return;
            }
            
            const topic = `robotika/${topicId}/config/set_schedule`;
            // Kirim array waktu dalam format JSON
            const payload = JSON.stringify({ scheduledTimes: scheduledTimes });
            
            publishControl(topic, payload);
            window.chambers[topicId].log.push({ time: new Date().toLocaleTimeString('id-ID'), message: `Perintah Jadwal Waktu dikirim: ${scheduledTimes.join(', ')}.` });
            updateDetailUI(window.chambers[topicId]);
            hideScheduleModal();
        }

        // --- 7. FUNGSI MODAL ---
        window.showScheduleModal = (topicId) => {
            document.getElementById('schedule-modal').dataset.topicId = topicId;
            document.getElementById('schedule-chamber-name').textContent = `Mengatur jadwal untuk: ${window.chambers[topicId].name}`;
            document.getElementById('schedule-modal').classList.remove('hidden');
        }
        window.hideScheduleModal = () => document.getElementById('schedule-modal').classList.add('hidden');


        // --- APLIKASI MULAI ---
        window.onload = function() {
            // Inisialisasi Firebase akan dipanggil setelah login berhasil.
        };

    </script>
</body>
</html>